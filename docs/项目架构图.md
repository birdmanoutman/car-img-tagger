# 🚗 汽车图片智能标注系统 - 项目架构文档

## 📋 目录
- [系统概述](#系统概述)
- [架构总览](#架构总览)
- [核心模块详解](#核心模块详解)
- [标签体系](#标签体系)
- [数据流转](#数据流转)
- [技术栈](#技术栈)
- [部署架构](#部署架构)

## 🎯 系统概述

汽车图片智能标注系统是一个基于深度学习的自动化图片标注平台，专门针对汽车图片进行多维度标签识别。系统支持角度、品牌、风格、颜色等多种标签类型的自动识别，并结合主动学习技术提高标注质量。

### 核心功能
- 🤖 **自动标注**: 基于CLIP/SigLIP的多标签自动识别
- 📊 **主动学习**: 智能筛选需要人工审核的图片
- 🌐 **Web界面**: 直观的图片管理和标签编辑界面
- 🗄️ **数据管理**: 完整的数据存储和检索系统
- ⚡ **模型部署**: ONNX/TensorRT优化的高性能推理

## 🏗️ 架构总览

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                🎯 汽车图片智能标注系统                              │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                                 📊 数据层 (Data Layer)                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│  📁 原始数据                    📁 处理后数据                    📁 模型存储      │
│  ├─ 图片素材/                   ├─ processed_data/               ├─ models/      │
│  │  ├─ Cadillac/               │  ├─ annotations/               │  ├─ *.onnx     │
│  │  ├─ Ferrari/                │  ├─ auto_annotated_dataset.csv │  ├─ *.plan     │
│  │  ├─ Honda/                  │  └─ review_queue.json         │  └─ *.pt       │
│  │  ├─ MINI/                   │                               │                │
│  │  ├─ Nissan/                 ├─ databases/                   └─ output/      │
│  │  ├─ Porsche/                │  └─ car_tags.db               └─ reports/      │
│  │  ├─ Smart/                  │                               │                │
│  │  └─ Toyota/                 │                               │                │
│  └─ 各标签素材/                 │                               │                │
│      ├─ 角度样本/               │                               │                │
│      └─ 品牌样本/               │                               │                │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              🧠 AI核心模块 (AI Core)                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│  🔍 VisionLanguageModel        🤖 CarImageTagger           📈 ActiveLearning     │
│  ├─ CLIP/SigLIP支持            ├─ 多标签分类               ├─ 不确定性计算       │
│  ├─ 图像特征提取               ├─ 置信度评估               ├─ 熵值分析           │
│  ├─ 文本特征编码               ├─ 标签映射                 ├─ 边际置信度         │
│  └─ 概率预测                  └─ 批量处理                 └─ 审核队列生成       │
│                                                                                 │
│  🎨 ColorDetection            🗄️ Database                ⚡ Deployment         │
│  ├─ HSV颜色空间               ├─ SQLite存储              ├─ ONNX导出           │
│  ├─ K-means聚类               ├─ 图片元数据               ├─ TensorRT优化       │
│  ├─ 主色调提取                ├─ 标签关联                 ├─ 模型压缩           │
│  └─ 颜色分类                  └─ 统计查询                 └─ 推理加速           │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                            🌐 Web应用层 (Web Layer)                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│  🚀 FastAPI应用 (app.py)        🎨 前端界面                📡 REST API           │
│  ├─ 图片管理                   ├─ Bootstrap UI             ├─ /api/images       │
│  ├─ 标签编辑                   ├─ 响应式设计               ├─ /api/search       │
│  ├─ 搜索过滤                   ├─ 图片展示                 ├─ /api/statistics   │
│  ├─ 统计分析                   ├─ 标签管理                 ├─ /api/brands       │
│  └─ 缩略图服务                 └─ 分页导航                 └─ /api/angles       │
│                                                                                 │
│  📁 静态资源                    📄 模板引擎                🔧 配置管理           │
│  ├─ static/style.css           ├─ Jinja2模板               ├─ config.py         │
│  ├─ templates/base.html        ├─ 动态内容                 ├─ 路径配置           │
│  └─ templates/index.html       └─ 数据绑定                 └─ 模型参数           │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              🛠️ 脚本工具层 (Scripts)                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│  📝 auto_tag.py                📋 build_review_queue.py    🌐 run_server.py     │
│  ├─ 批量自动标注               ├─ 主动学习队列             ├─ 启动Web服务        │
│  ├─ 多品牌处理                 ├─ 不确定性筛选             ├─ 热重载支持         │
│  ├─ 置信度评估                 ├─ JSON导出                 └─ 端口配置           │
│  └─ CSV结果导出                └─ Label Studio集成         │                    │
│                                                                                 │
│  🎯 train_angle_classifier.py  🏷️ run_enhanced_brand_tagger.py  📤 export_encoder.py │
│  ├─ EfficientNet训练          ├─ 集成品牌标注             ├─ SigLIP导出         │
│  ├─ 角度分类                   ├─ 多模型融合               ├─ ONNX转换          │
│  ├─ 数据增强                   └─ 历史兼容                 └─ TensorRT构建     │
│  └─ 模型评估                   │                          │                    │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 🧩 核心模块详解

### 1. 视觉语言模型 (VisionLanguageModel)
- **位置**: `src/car_img_tagger/modeling/vision_language.py`
- **功能**: 统一的CLIP/SigLIP模型接口
- **特性**:
  - 支持多种预训练模型
  - 图像和文本特征提取
  - 跨模态相似度计算
  - 概率预测

### 2. 汽车图片标注器 (CarImageTagger)
- **位置**: `src/car_img_tagger/auto_tagging.py`
- **功能**: 核心标注逻辑
- **特性**:
  - 多标签分类
  - 置信度评估
  - 批量处理
  - 结果聚合

### 3. 主动学习模块 (ActiveLearning)
- **位置**: `src/car_img_tagger/active_learning.py`
- **功能**: 智能筛选需要人工审核的样本
- **指标**:
  - 熵值 (Entropy): 衡量预测不确定性
  - 边际置信度 (Margin): 最高和次高预测间的差值
  - 最大置信度 (Max Confidence): 最高预测的置信度

### 4. 数据库模块 (Database)
- **位置**: `src/car_img_tagger/database.py`
- **功能**: 数据持久化和检索
- **表结构**:
  - `images`: 图片元数据
  - `tags`: 标签定义
  - `image_tags`: 图片标签关联
  - `annotation_history`: 标注历史

### 5. 颜色检测模块 (ColorDetection)
- **位置**: `src/car_img_tagger/color_detection.py`
- **功能**: 汽车颜色自动识别
- **技术**:
  - HSV颜色空间转换
  - K-means聚类
  - 主色调提取
  - 颜色分类映射

## 🏷️ 标签体系

### 📐 角度标签 (24个)
系统支持24种不同的拍摄角度和部位标签：

**外观角度 (5个)**:
- `1-前45`: 前45度角视图
- `2-正侧`: 正侧面视图
- `3-后45`: 后45度角视图
- `4-正前`: 正前方视图
- `5-正后`: 正后方视图

**外部部件 (9个)**:
- `6-头灯`: 前大灯特写
- `7-尾灯`: 尾灯特写
- `8-格栅`: 前格栅特写
- `8-轮毂`: 轮毂特写
- `9-尾翼`: 尾翼特写
- `17-天窗`: 天窗视图
- `22-扩散器`: 后扩散器
- `23-C柱`: C柱细节
- `24-充电口`: 充电接口

**内饰标签 (10个)**:
- `10-内饰`: 整体内饰视图
- `11-方向盘`: 方向盘特写
- `12-中控屏`: 中控显示屏
- `13-CONSOLE`: 中控台
- `14-座椅`: 座椅视图
- `15-门板`: 车门内饰板
- `16-旋钮`: 控制旋钮
- `16-球头`: 换挡球头
- `18-后备箱`: 后备箱内部
- `19-前备箱`: 前备箱(电动车)
- `20-出风口`: 空调出风口
- `21-仪表屏`: 仪表盘显示屏

### 🏭 品牌标签 (8个)
系统当前支持8个主要汽车品牌：
- `Cadillac`: 凯迪拉克
- `Ferrari`: 法拉利
- `Honda`: 本田
- `MINI`: 宝马MINI
- `Nissan`: 日产
- `Porsche`: 保时捷
- `Smart`: 奔驰Smart
- `Toyota`: 丰田

### 🎨 风格标签 (16个)
汽车设计风格和车型分类：

**动力类型**:
- `新能源`: 电动/混动车型
- `运动`: 运动风格设计
- `豪华`: 豪华车型
- `概念车`: 概念车设计

**设计风格**:
- `复古`: 复古设计元素
- `现代`: 现代化设计
- `经典`: 经典设计语言
- `未来感`: 未来主义设计
- `商务`: 商务用车
- `家用`: 家庭用车

**车型分类**:
- `越野`: 越野车/SUV
- `跑车`: 跑车/超跑
- `SUV`: 运动型多用途车
- `轿车`: 三厢轿车
- `掀背车`: 两厢/掀背车型
- `敞篷车`: 敞篷车型

### 🌈 颜色标签 (15个)
支持的汽车颜色分类：

**基础颜色**:
- `黑色`、`白色`、`银色`、`灰色`
- `红色`、`蓝色`、`绿色`、`黄色`
- `橙色`、`紫色`、`棕色`

**特殊颜色**:
- `金色`、`香槟色`、`珍珠白`、`金属漆`

### 🔧 内饰精细标签 (8个)
专业内饰部件识别：
- `方向盘细节`: 方向盘控制按键等
- `换挡球头`: 自动挡换挡球头
- `换挡杆`: 手动挡换挡杆
- `中控旋钮`: 中控台控制旋钮
- `空调出风口环`: 出风口装饰环
- `座椅包覆`: 座椅皮革/织物材质
- `门板饰条`: 车门装饰条
- `驾驶模式旋钮`: 驾驶模式选择器

## 🔄 数据流转

### 1. 数据预处理阶段
```
原始图片 → 格式标准化 → 元数据提取 → 数据库存储
```

### 2. AI标注阶段
```
图片输入 → VisionLanguage模型 → 特征提取 → 多标签预测 → 置信度计算
```

### 3. 主动学习阶段
```
预测结果 → 不确定性分析 → 熵值计算 → 边际分析 → 审核队列生成
```

### 4. 人工审核阶段
```
审核队列 → Label Studio → 专家标注 → 反馈收集 → 数据库更新
```

### 5. 模型优化阶段
```
标注数据 → 模型微调 → 性能评估 → 参数优化 → 版本发布
```

## 🛠️ 技术栈

### 后端技术
- **Web框架**: FastAPI
- **AI框架**: PyTorch, Transformers
- **数据库**: SQLite
- **图像处理**: OpenCV, PIL
- **数据分析**: Pandas, NumPy

### 前端技术
- **UI框架**: Bootstrap 5
- **模板引擎**: Jinja2
- **图标**: Bootstrap Icons
- **交互**: Vanilla JavaScript

### AI模型
- **视觉语言模型**: CLIP, SigLIP
- **图像分类**: EfficientNet
- **特征提取**: Vision Transformer

### 部署技术
- **模型优化**: ONNX, TensorRT
- **容器化**: Docker
- **Web服务**: Uvicorn

## 🚀 部署架构

### 开发环境
```
开发机 → Git → 本地测试 → 模型训练 → 性能验证
```

### 生产环境
```
Web应用 → FastAPI → ONNX模型 → TensorRT加速 → 数据库存储
```

### 扩展架构
```
负载均衡 → 多实例部署 → Redis缓存 → 分布式存储 → 监控告警
```

## 📊 系统配置

### 模型配置
- **SigLIP模型**: `google/siglip-base-patch16-224`
- **数据类型**: FP16 (半精度)
- **批处理大小**: 32
- **图像尺寸**: 224x224

### 主动学习配置
- **熵值阈值**: 1.1
- **边际阈值**: 0.25
- **最大队列大小**: 200

### 数据库配置
- **SQLite路径**: `databases/car_tags.db`
- **索引策略**: 品牌、来源、标签类别
- **备份策略**: 定期导出CSV

## 🔧 使用指南

### 快速启动
```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 启动Web服务
python scripts/run_server.py

# 3. 批量标注
python scripts/auto_tag.py --max-per-brand 50

# 4. 生成审核队列
python scripts/build_review_queue.py processed_data/auto_annotated_dataset.csv
```

### 模型导出
```bash
# 导出ONNX模型
python scripts/auto_tag.py --export-encoder

# 训练角度分类器
python scripts/train_angle_classifier.py
```

### API使用
```bash
# 获取图片列表
GET /api/images?brand=Ferrari&page=1&limit=20

# 搜索图片
GET /api/search?q=红色&category=colors

# 获取统计信息
GET /api/statistics
```

## 📈 性能指标

### 标注性能
- **处理速度**: ~2秒/图片 (GPU)
- **准确率**: 
  - 角度识别: 85%+
  - 品牌识别: 90%+
  - 风格识别: 80%+

### 系统性能
- **并发能力**: 100+ 用户
- **响应时间**: <500ms
- **存储效率**: 压缩比 3:1

## 🔮 未来规划

### 短期目标
- [ ] 支持更多汽车品牌
- [ ] 优化标注准确率
- [ ] 增加实时标注功能
- [ ] 改进Web界面体验

### 长期目标
- [ ] 多模态融合 (文本+图像)
- [ ] 分布式部署支持
- [ ] 自动化数据增强
- [ ] 智能标注质量评估

---

*文档版本: v1.0 | 最后更新: 2025-09-26*
